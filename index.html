<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å¤§æ•°æ®æ£€ç´¢å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="fast-find.js"></script>
    <style>
        :root { color-scheme: light dark; }
        * { box-sizing: border-box; }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            margin: 0; 
            background: #0b0c10; 
            color: #e6edf3; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header { 
            padding: 12px 16px; 
            background: #161b22; 
            border-bottom: 1px solid #30363d; 
            flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 18px; }
        
        .toolbar {
            padding: 12px 16px;
            background: #0d1117;
            border-bottom: 1px solid #30363d;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: end;
            flex-shrink: 0;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        label { font-size: 12px; color: #8b949e; }
        
        input {
            background: #0b0c10;
            border: 1px solid #30363d;
            color: #e6edf3;
            padding: 6px 12px;
            border-radius: 6px;
            font-family: monospace;
            min-width: 120px;
        }
        
        button {
            background: #1f6feb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.secondary { background: #21262d; border: 1px solid #30363d; color: #c9d1d9; }
        
        .status-bar {
            padding: 4px 16px;
            font-size: 12px;
            color: #8b949e;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
        }

        /* è™šæ‹Ÿåˆ—è¡¨å®¹å™¨ */
        #list-container {
            flex: 1;
            overflow-y: auto;
            position: relative;
            background: #0b0c10;
            contain: strict;
        }
        
        /* æ’‘å¼€é«˜åº¦çš„å¹½çµå…ƒç´  */
        #phantom {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            z-index: -1;
        }
        
        /* å®é™…æ¸²æŸ“å†…å®¹çš„å®¹å™¨ */
        #list-content {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
        }
        
        .list-item {
            height: 30px; /* å›ºå®šé«˜åº¦ï¼Œä¸JSä¸­ ITEM_HEIGHT ä¸€è‡´ */
            line-height: 30px;
            padding: 0 16px;
            border-bottom: 1px solid #21262d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: monospace;
            font-size: 13px;
        }
        .list-item:hover { background: #161b22; }
        
        .highlight { color: #7ee787; font-weight: bold; }
    </style>
</head>
<body>
    <header>
        <h1>å¤§æ•°æ®æ£€ç´¢å·¥å…· (Virtual List)</h1>
    </header>
    
    <div class="toolbar">
        <div class="input-group">
            <label>æ•°æ®æº</label>
            <button id="loadBtn">è¯»å– abc.txt</button>
        </div>
        <div class="input-group">
            <label>å§“æ° (é¦–å­—)</label>
            <input id="surnameInput" placeholder="å¦‚ï¼šå¼ " maxlength="1">
        </div>
        <div class="input-group">
            <label>å¹´ä»½ (ç¬¬7-10ä½)</label>
            <input id="yearInput" placeholder="å¦‚ï¼š1990" maxlength="4">
        </div>
        <div class="input-group">
            <label>çœä»½ (å‰2ä½)</label>
            <input id="provinceInput" placeholder="å¦‚ï¼š33" maxlength="2">
        </div>
        <div class="input-group">
            <label>&nbsp;</label>
            <button id="searchBtn" disabled>ğŸ” ç­›é€‰</button>
        </div>
        <div class="input-group">
            <label>&nbsp;</label>
            <button id="resetBtn" class="secondary" disabled>é‡ç½®</button>
        </div>
    </div>

    <div class="status-bar">
        <span id="status">å°±ç»ª</span>
        <span id="count">å…± 0 æ¡æ•°æ®</span>
    </div>

    <div id="list-container">
        <div id="phantom"></div>
        <div id="list-content"></div>
    </div>

    <script>
        // é…ç½®
        const FILE_URL = 'def.txt';
        const ITEM_HEIGHT = 30; // åˆ—è¡¨é¡¹é«˜åº¦ px
        const BUFFER_SIZE = 10; // ä¸Šä¸‹ç¼“å†²æ¸²æŸ“æ•°é‡

        // çŠ¶æ€
        let ALL_DATA = []; // æ¸…æ´—åçš„å®Œæ•´æ•°æ®
        let DISPLAY_DATA = []; // å½“å‰å±•ç¤ºçš„æ•°æ®ï¼ˆç­›é€‰åï¼‰
        let isReading = false;
        const fastFind = new FastFind();

        // DOM å…ƒç´ 
        const listContainer = document.getElementById('list-container');
        const phantom = document.getElementById('phantom');
        const listContent = document.getElementById('list-content');
        const statusEl = document.getElementById('status');
        const countEl = document.getElementById('count');
        const loadBtn = document.getElementById('loadBtn');
        const searchBtn = document.getElementById('searchBtn');
        const resetBtn = document.getElementById('resetBtn');

        // è¾“å…¥æ¡†
        const surnameInput = document.getElementById('surnameInput');
        const yearInput = document.getElementById('yearInput');
        const provinceInput = document.getElementById('provinceInput');

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ•°æ®è¯»å–ä¸æ¸…æ´— ---

        async function loadData() {
            if (isReading) return;
            isReading = true;
            loadBtn.disabled = true;
            loadBtn.textContent = 'è¯»å–ä¸­...';
            statusEl.textContent = 'æ­£åœ¨è¯»å–å¹¶æ¸…æ´—æ•°æ®...';
            
            ALL_DATA = [];
            let pendingLine = null; // ç”¨äºæš‚å­˜éœ€è¦åˆå¹¶çš„çº¯æ–‡æœ¬è¡Œ
            let rawCount = 0;

            Papa.parse(FILE_URL, {
                download: true,
                step: function(row, parser) {
                    // ç®€å•çš„æµå¼å¤„ç†
                    let line = row.data;
                    if (Array.isArray(line)) line = line.join(' ');
                    line = line ? line.trim() : '';
                    
                    if (!line) return;
                    rawCount++;

                    // ç®€å•çš„æ ¼å¼åˆ¤æ–­ï¼šæ˜¯å¦åŒ…å«æ•°å­—
                    const hasDigit = /\d/.test(line);

                    if (hasDigit) {
                        if (pendingLine) {
                            // å¦‚æœæœ‰æŒ‚èµ·çš„æ–‡æœ¬è¡Œï¼Œåˆå¹¶
                            ALL_DATA.push(pendingLine + ' ' + line);
                            pendingLine = null;
                        } else {
                            // æ­£å¸¸è¡Œï¼ˆå‡è®¾åŒ…å«æ–‡æœ¬å’Œæ•°å­—ï¼Œæˆ–è€…åªæ˜¯æ•°å­—ä½†æ²¡å‰æ–‡ï¼‰
                            // éœ€æ±‚ï¼šä¿è¯æ¯ä¸€è¡Œéƒ½æ˜¯â€œæ±‰å­—æˆ–å­—æ¯+ç©ºæ ¼+æ•°å­—â€
                            // å¦‚æœå½“å‰è¡Œæ—¢æœ‰æ±‰å­—åˆæœ‰æ•°å­—ï¼Œç›´æ¥æ·»åŠ 
                            // å¦‚æœå½“å‰è¡Œåªæœ‰æ•°å­—ï¼Œä¸”æ²¡æœ‰pendingLineï¼Œå¯èƒ½æ˜¯ä¸å®Œæ•´æ•°æ®ï¼Œä½†æš‚ä¸”ä¿ç•™
                            ALL_DATA.push(line);
                        }
                    } else {
                        // åªæœ‰æ±‰å­—æˆ–å­—æ¯
                        if (pendingLine) {
                            // è¿ç»­ä¸¤è¡Œçº¯æ–‡æœ¬ï¼Ÿä¸¢å¼ƒä¸Šä¸€è¡Œæˆ–åˆå¹¶ï¼Ÿ
                            // ç®€å•èµ·è§ï¼Œä¸¢å¼ƒä¸Šä¸€è¡Œï¼Œä¿ç•™æœ€æ–°
                            pendingLine = line;
                        } else {
                            pendingLine = line;
                        }
                    }

                    if (rawCount % 50000 === 0) {
                        statusEl.textContent = `å·²è¯»å– ${rawCount.toLocaleString()} è¡Œ...`;
                    }
                },
                complete: function() {
                    isReading = false;
                    loadBtn.textContent = 'è¯»å–å®Œæˆ';
                    statusEl.textContent = 'æ•°æ®å¤„ç†å®Œæ¯•';
                    
                    // åˆå§‹åŒ–å±•ç¤º
                    DISPLAY_DATA = ALL_DATA;
                    
                    // æ„å»ºç´¢å¼•
                    statusEl.textContent = 'æ­£åœ¨æ„å»ºç´¢å¼•...';
                    // ç»™ UI ä¸€ç‚¹æ—¶é—´æ¸²æŸ“çŠ¶æ€
                    setTimeout(() => {
                        fastFind.setData(ALL_DATA);
                        statusEl.textContent = 'æ•°æ®å¤„ç†å®Œæ¯•';
                        updateCount();
                        initVirtualList();
                        
                        searchBtn.disabled = false;
                        resetBtn.disabled = false;
                    }, 50);
                },
                error: function(err) {
                    console.error(err);
                    statusEl.textContent = 'è¯»å–å¤±è´¥: ' + err.message;
                    loadBtn.disabled = false;
                    loadBtn.textContent = 'é‡è¯•è¯»å–';
                    isReading = false;
                    alert(`æ— æ³•è¯»å– ${FILE_URL}ã€‚è¯·ç¡®ä¿ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œã€‚`);
                }
            });
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šç­›é€‰ ---

        function performSearch() {
            if (!ALL_DATA.length) return;

            const surname = surnameInput.value.trim();
            const year = yearInput.value.trim();
            const province = provinceInput.value.trim();

            statusEl.textContent = 'æ­£åœ¨ç­›é€‰...';
            
            // ä½¿ç”¨ requestAnimationFrame é¿å…é˜»å¡ UI
            requestAnimationFrame(() => {
                const startTime = performance.now();
                
                // ä½¿ç”¨ FastFind è¿›è¡Œé«˜æ€§èƒ½æ£€ç´¢
                DISPLAY_DATA = fastFind.search({ surname, year, province });
                
                const endTime = performance.now();
                console.log(`Search took ${endTime - startTime}ms`);

                statusEl.textContent = `ç­›é€‰å®Œæˆ (è€—æ—¶ ${(endTime - startTime).toFixed(2)}ms)`;
                updateCount();
                
                // é‡ç½®æ»šåŠ¨æ¡å¹¶é‡æ–°æ¸²æŸ“
                listContainer.scrollTop = 0;
                initVirtualList();
            });
        }

        function resetSearch() {
            surnameInput.value = '';
            yearInput.value = '';
            provinceInput.value = '';
            DISPLAY_DATA = ALL_DATA;
            updateCount();
            listContainer.scrollTop = 0;
            initVirtualList();
        }

        function updateCount() {
            countEl.textContent = `æ˜¾ç¤º ${DISPLAY_DATA.length.toLocaleString()} æ¡ / å…± ${ALL_DATA.length.toLocaleString()} æ¡`;
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè™šæ‹Ÿåˆ—è¡¨æ¸²æŸ“ ---

        function initVirtualList() {
            // è®¾ç½®å¹½çµå…ƒç´ é«˜åº¦
            const totalHeight = DISPLAY_DATA.length * ITEM_HEIGHT;
            phantom.style.height = `${totalHeight}px`;
            renderVirtualList();
        }

        function renderVirtualList() {
            const scrollTop = listContainer.scrollTop;
            const containerHeight = listContainer.clientHeight;

            // è®¡ç®—å¯è§†åŒºåŸŸçš„èµ·å§‹å’Œç»“æŸç´¢å¼•
            const startIndex = Math.floor(scrollTop / ITEM_HEIGHT);
            const endIndex = Math.min(
                DISPLAY_DATA.length, 
                Math.ceil((scrollTop + containerHeight) / ITEM_HEIGHT)
            );

            // åŠ ä¸Šç¼“å†²åŒºåŸŸ
            const renderStart = Math.max(0, startIndex - BUFFER_SIZE);
            const renderEnd = Math.min(DISPLAY_DATA.length, endIndex + BUFFER_SIZE);

            // ç”ŸæˆHTML
            let html = '';
            for (let i = renderStart; i < renderEnd; i++) {
                const item = DISPLAY_DATA[i];
                // ç®€å•é«˜äº®å¤„ç†ï¼ˆå¯é€‰ï¼Œä¼šå½±å“æ€§èƒ½ï¼Œè¿™é‡Œæš‚ä¸åšå¤æ‚é«˜äº®ï¼‰
                html += `<div class="list-item">${item}</div>`;
            }

            listContent.innerHTML = html;
            
            // åç§» content ä½ç½®
            listContent.style.transform = `translateY(${renderStart * ITEM_HEIGHT}px)`;
        }

        // --- äº‹ä»¶ç›‘å¬ ---

        loadBtn.addEventListener('click', loadData);
        searchBtn.addEventListener('click', performSearch);
        resetBtn.addEventListener('click', resetSearch);

        // æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼ˆèŠ‚æµä¼˜åŒ–å¯é€‰ï¼Œä½†ç°ä»£æµè§ˆå™¨å¤„ç† scroll å¾ˆå¿«ï¼‰
        listContainer.addEventListener('scroll', () => {
            requestAnimationFrame(renderVirtualList);
        });

        // å›è½¦æœç´¢
        [surnameInput, yearInput, provinceInput].forEach(input => {
            input.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') performSearch();
            });
        });

    </script>
</body>
</html>